<div style="width: 100%; display: flex; justify-content: center;">
  <img alt="Hi. I am Chidi, your soulmate." src="chidi.png" />
</div>

# chidi

Simple API library and generators.

## Motivation

To create and maintain framework for real-time applicaitons and REST APIs akin
to [Feathers] plus [JAMStack] in [Janet] programming language.  Better name will
be WAMStack, as I would like to use wasm for FE.

At the begining it will be only backend story. Service are generated by the
macros. All html will be static, generated also by [Mendoza].

## Installation 

You need to have [Janet] language and all dependencies installed. Then you can
install `chidi` with `jpm`:

`[sudo] jpm install chidi`

## Usage

### App Generation

When you have  `chidi` installed you can generate new application with it:

`chd generate --app-name test-chidi`

Then you need to `cd test-chidi` and run server:
- / root, which can be used as ping service
- not-found for everything else

`chd server`

Only 'application/json' content-type is accepted by the server. You can test it
with curl: 

`curl -v -H "Accept: application/json" http://127.0.0.1:8130/`

### Service generation

#### SQLite service

You can generate simple SQLite backed API service with `chidi`:

`chd generate --service people --setup`

This command will create new people service and setup, which needs a little
more editing to run. 

Structure of test-chidi project should be:


```
.
├── app
│  ├── common
│  │  └── service.janet
│  ├── init.janet
│  └── people
│     ├── service.janet
│     └── setup.janet
└── project.janet
```

In `project.janet` file you should add the description or dependencies of your
project.

In the `app` directory is all the code for your project. In the root of this
directory is the `init.janet` file, which is the main entry point. We need to
start editing here. Open it and under 5th line, where is the common service
import add import for newly created service and its setup facilities:

```
(import app/people/service :as people)
(import app/people/setup)
```

Then you have to add routes for newly created service to the routes constant:

```
(def- routes (merge people/routes common/routes))
```

You also have to add people setup to app setup:
```
(defn setup [db-file]
  (print "=== Recreating db ===")
  (app/people/setup/perform db-file)
  (print "--- Done ---"))
```

Last thing before we can run our shiny new service is to fix people setup. Open
`app/people/setup.janet` and fix the table definition, for example:

```
(defn perform [dbf]
  (su/open dbf)
  (su/drop-table :people)
  (su/create-table :people
    {:name :TEXT :gender :TEXT :height :INTEGER :weight :INTEGER :born :TEXT})
  (su/close))
```

Now we can setup the database:

```
chd setup 
```

Last thing that needs to be fixed are the keys which are allowed for db
operations in `app/people/service.janet` on 5th line to:

```
(service/defservice :people {:allowed-keys [:name :gender :weight :height :born]})
```

And run our first db service:

```
chd 
```

In the second terminal, check if everything is running:

```
curl -v -H "Accept: application/json" http://127.0.0.1:8130/people
=> []
```

You can see that our db is empty, let's add first person:

```
curl -v --request POST -H "Accept: application/json" --data "{\"name\": \"Prima Prvy\", \"gender\": \"all\", \"weight\": 99, \"height\": 199, \"born\": \"1980-04-24\"}" "http://127.0.0.1:8130/people"
=> {"id":1,"name":"Prima Prvy","born":"1980-04-24","gender":"all","weight":99,"height":199}
```

Now check if it is there:

```
curl -v -H "Accept: application/json" http://127.0.0.1:8130/people
=> [{"id":1,"name":"Prima Prvy","born":"1980-04-24","gender":"all","weight":99,"height":199}]
```

As you can see our first person is stored with our service.

## TODO

- [ ] @todo add more documentation
- [ ] @todo add application tests with embedded circlet server
- [ ] @todo generate file contents with mdz
- [x] @todo add library tests
- [x] make chd binary only binary with argparse
- [x] remove test app and tests
- [x] make standalone lib
- [x] add service macros
- [x] separate framework from application code
- [x] minimal working example
  - [x] circlet server
  - [x] json only services
  - [x] sqlite storage
  - [x] all usable http verbs

[Janet]: https://janet-lang.org/index.html
[Feathers]: https://feathersjs.com/
[Mendoza]: https://github.com/bakpakin/mendoza
[JAMStack]: https://jamstack.org/
