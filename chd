#!/usr/bin/env janet
(import argparse :prefix "")

(import chidi)
(import chidi/generate)

(def argparse-params
  [```Chidi CLI. Used to run everything.

 Options:
  server: to run circlet
  generate: to generate app or service```
   :default {:kind :option
             :default "server"
             :help "Command to run"}
   "app-name" {:kind :option
               :help "Name of the app to generate the stub for"}
   "service" {:kind :option
              :help "Name of the service to generate"}
   "to-index" {:kind :option
               :help "What fields to index in store"
               :default []}
   "port" {:kind :option
           :help "HTTP server port"
           :default 8130}
   "host" {:kind :option
           :help "HTTP server host"
           :default "localhost"}])

(let [res (argparse ;argparse-params)]
  (unless res
    (os/exit 1))
  (let [{:default command "host" host "port" port} res]
    (case command
     "server" (chidi/app-server port)
     "generate" (if-let [name (res "app-name")]
                  (generate/app name)
                  (if-let [service (res "service")]
                   (generate/service service {:to-index (tuple ;(string/split "," (res "to-index")))})
                   (error "You have to specifiy service name to generate")))
     (error "This command I do not recognize"))))


